<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Services Management</title>
    <style>
        .select2-container--open {
    z-index: 99999;
}
    </style>
</head>
<body>
<div layout:fragment="page-title">Services Management</div>

<div layout:fragment="page-actions">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
        <i class="fas fa-plus"></i> Add Service
    </button>
</div>

<div layout:fragment="content">
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="providerFilter" class="form-label">Provider</label>
                        <select class="form-select" id="providerFilter" name="provider">
                            <option value="">All Providers</option>
                            <option value="STC">STC</option>
                            <option value="Mobily">Mobily</option>
                            <option value="Zain">Zain</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" name="status">
                            <option value="">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="assignedToFilter" class="form-label">Assigned To</label>

                        <select class="form-select" id="assignedToFilter" name="assignedTo">
                            <option value="">All</option>
                            <option value="employee">Employees</option>
                            <option value="department">Departments</option>
                            <option value="branch">Branches</option>
                        </select>

                    </div>
                    <div class="col-md-3">
                        <label for="searchInput" class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search services...">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Services Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Services List</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="servicesTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <th>Service ID</th>
                        <th>Provider</th>
                        <th>Account Number</th>
                        <th>Serial Number</th>
                        <th>Monthly Fee</th>
                        <th>Activation Date</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${services != null}" th:each="service : ${services}">
                        <td th:text="${service.id}">SRV-001</td>
                        <td th:text="${service.provider}">STC</td>
                        <td th:text="${service.accountNumber}">ACC-12345</td>
                        <td th:text="${service.serialNumber}">SN-67890</td>
                        <td th:text="${service.monthlyFee}">$25.00</td>
                        <td th:text="${service.activationDate}">2023-01-15</td>
                        <td>
                            <span class="badge bg-success" th:if="${service.status == 'Active'}">Active</span>
                            <span class="badge bg-secondary" th:if="${service.status == 'Inactive'}">Inactive</span>
                        </td>
                        <td th:text="${service.assignedTo}">IT Department</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-info view-service" data-bs-toggle="modal" data-bs-target="#viewServiceModal" th:data-id="${service.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary edit-service" data-bs-toggle="modal" data-bs-target="#addServiceModal" th:data-id="${service.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-service" th:data-id="${service.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addServiceModalLabel">Add New Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm" th:action="@{/services/save}" th:object="${service}" method="post">
                        <input type="hidden" id="serviceId" th:field="*{id}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="provider" class="form-label">Provider</label>
                                <select class="form-select" id="provider" th:field="*{provider}" required>
                                    <option value="">Select Provider</option>
                                    <option value="STC">STC</option>
                                    <option value="Mobily">Mobily</option>
                                    <option value="Zain">Zain</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('provider')}" th:errors="*{provider}">Provider is required</div>
                            </div>
                            <div class="col-md-6">
                                <label for="accountNumber" class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" th:field="*{accountNumber}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('accountNumber')}" th:errors="*{accountNumber}">Account Number is required</div>
                            </div>

                            <div class="col-md-6">
                                <label for="type" class="form-label">Type</label>
                                <select class="form-select" id="type" th:field="*{type}" required>
                                    <option value="SIM-Card">SIM-Card</option>
                                    <option value="5G-Internet">5G-Internet</option>
                                    <option value="Fiber-Internet">Fiber-Internet</option>
                                    <option value="IP-VPN">IP-VPN</option>
                                    <option value="IP-VPN">LandLine</option>

                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}">Status is required</div>
                            </div>

                            <div class="col-md-6">
                                <label for="serialNumber" class="form-label">Serial Number</label>
                                <input type="text" class="form-control" id="serialNumber" th:field="*{serialNumber}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('serialNumber')}" th:errors="*{serialNumber}">Serial Number is required</div>
                            </div>
                            <div class="col-md-6">
                                <label for="monthlyFee" class="form-label">Monthly Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">SAR</span>
                                    <input type="number" class="form-control" id="monthlyFee" th:field="*{monthlyFee}" step="0.01" min="0" required>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('monthlyFee')}" th:errors="*{monthlyFee}">Valid monthly fee is required</div>
                            </div>
                            <div class="col-md-6">
                                <label for="activationDate" class="form-label">Activation Date</label>
                                <input type="date" class="form-control" id="activationDate" th:field="*{activationDate}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('activationDate')}" th:errors="*{activationDate}">Activation Date is required</div>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" th:field="*{status}" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}">Status is required</div>
                            </div>
                            <div class="col-12">
                                <label for="assignedTo" class="form-label">Assign To</label>

                                <select class="form-select" id="assignedTo" th:field="*{assignedToId}" required>
                                    <option value="">Select Employee, Department or Branch</option>

                                    <optgroup label="Employees">
                                        <option th:each="employee:${employees}" th:text="${employee.name}" th:value="${'employee-' + employee.id}"></option>
                                    </optgroup>

                                    <optgroup label="Departments">
                                        <option th:each="department:${departments}" th:text="${department.name}" th:value="${'department-' + department.id}"></option>
                                    </optgroup>

                                    <optgroup label="Branches">
                                        <option th:each="branch:${branches}" th:text="${branch.name}" th:value="${'branch-' + branch.id}"></option>
                                    </optgroup>
                                </select>

                                <div class="invalid-feedback" th:if="${#fields.hasErrors('assignedToId')}" th:errors="*{assignedToId}">Assignment is required</div>
                            </div>
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" th:field="*{notes}" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveService">Save Service</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Service Modal -->
    <div class="modal fade" id="viewServiceModal" tabindex="-1" aria-labelledby="viewServiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewServiceModalLabel">Service Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Service ID:</strong> <span id="viewServiceId"></span></p>
                            <p><strong>Provider:</strong> <span id="viewProvider"></span></p>
                            <p><strong>Account Number:</strong> <span id="viewAccountNumber"></span></p>
                            <p><strong>Serial Number:</strong> <span id="viewSerialNumber"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Monthly Fee:</strong> <span id="viewMonthlyFee"></span></p>
                            <p><strong>Activation Date:</strong> <span id="viewActivationDate"></span></p>
                            <p><strong>Status:</strong> <span id="viewStatus"></span></p>
                            <p><strong>Assigned To:</strong> <span id="viewAssignedTo"></span></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p><strong>Notes:</strong></p>
                        <p id="viewNotes"></p>
                    </div>
                    <div class="mb-3">
                        <h6>Payment History</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Due Date</th>
                                    <th>Payment Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                                </thead>
                                <tbody id="paymentHistory">
                                <tr>
                                    <td>September 2023</td>
                                    <td>2023-09-05</td>
                                    <td>2023-09-03</td>
                                    <td>$25.00</td>
                                    <td><span class="badge bg-success">Paid</span></td>
                                </tr>
                                <tr>
                                    <td>August 2023</td>
                                    <td>2023-08-05</td>
                                    <td>2023-08-01</td>
                                    <td>$25.00</td>
                                    <td><span class="badge bg-success">Paid</span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary edit-from-view" data-bs-toggle="modal" data-bs-target="#addServiceModal">Edit</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        $(document).ready(function() {
            // Initialize Select2 for searchable dropdowns
            $('#assignedTo').select2();

            // Initialize DataTable
            const servicesTable = $('#servicesTable').DataTable({
                responsive: true,
                pageLength: 10,
                dom: '<"row"<"col-sm-6"l><"col-sm-6"f>>rtip'
            });



            $('#searchButton').on('click', function() {
                servicesTable.search($('#searchInput').val()).draw();
            });

            $('#searchInput').on('keyup', function(e) {
                if (e.key === 'Enter') {
                    servicesTable.search($(this).val()).draw();
                }
            });

            // View Service
            $('.view-service').on('click', function() {
                const serviceId = $(this).data('id');
                // In a real application, you would fetch the service details via AJAX
                // For this example, we'll just show the modal
                $('#viewServiceModal').modal('show');
            });

            // Edit Service
            $('.edit-service').on('click', function() {
                const serviceId = $(this).data('id');
                // In a real application, you would fetch the service details via AJAX
                // For this example, we'll just show the modal
                $('#addServiceModalLabel').text('Edit Service');
                $('#serviceId').val(serviceId);
                $('#addServiceModal').modal('show');
            });

            // Delete Service
            $('.delete-service').on('click', function() {
                const serviceId = $(this).data('id');
                if (confirm('Are you sure you want to delete this service?')) {
                    // In a real application, you would send an AJAX request to delete the service
                    // For this example, we'll just remove the row from the table
                    $(this).closest('tr').remove();
                    // Show success message
                    const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">Service deleted successfully.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    $('.content').prepend(alert);
                    setTimeout(function() {
                        alert.alert('close');
                    }, 3000);
                }
            });

            // Reset form when modal is closed
            $('#addServiceModal').on('hidden.bs.modal', function() {
                $('#serviceForm')[0].reset();
                $('#addServiceModalLabel').text('Add New Service');
                $('#serviceId').val('');
            });

            // Save Service
            $('#saveService').on('click', function() {
                // In a real application, you would submit the form via AJAX
                // For this example, we'll just validate and show a success message
                if ($('#serviceForm')[0].checkValidity()) {
                    $('#addServiceModal').modal('hide');
                    const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">Service saved successfully.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    $('.content').prepend(alert);
                    setTimeout(function() {
                        alert.alert('close');
                    }, 3000);
                } else {
                    $('#serviceForm')[0].reportValidity();
                }
            });

            // Edit from View button
            $('.edit-from-view').on('click', function() {
                $('#viewServiceModal').modal('hide');
            });
        });
    </script>
</th:block>
</body>
</html>